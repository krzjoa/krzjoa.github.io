<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Double dispatch in R: S4 vs vctrs &middot; krzjoa
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        krzjoa
      </a>
    </div>
    <p class="lead">Getting at the Truth</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  
    
  

  

  
    
  

  
    
      <a class="page-link "
          href="/projects.html">Projects</a>
    
  

  
    
      <a class="page-link "
          href="/publications.html">Publications</a>
    
  

  
    
  

  
    
  

  
    
  


  


  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  <!--p><a href="/calc/calc.html">CNN Calculator</a></p-->
  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  

  <nav id="sidebar-icon-links">
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search.html">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <a id="github-link"
    class="icon" title="Github" aria-label="Github"
    href="https://github.com/krzjoa">
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28" height="24" width="28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

</a>

<!--a id="rbloggers-link"
    class="icon" title="R-bloggers" aria-label="R-bloggers"
    href="https://www.r-bloggers.com">
  <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   xmlns:osb="http://www.openswatchbook.org/uri/2009/osb"
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   id="svg12"
   preserveAspectRatio="xMidYMid meet"
   viewBox="0 0 400.000000 400.000000"
   height="400.000000pt"
   width="400.000000pt"
   version="1.0"
   sodipodi:docname="blg2.svg"
   inkscape:version="0.92.3 (2405546, 2018-03-11)">
  <metadata
     id="metadata18">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title />
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <defs
     id="defs16">
    <linearGradient
       id="linearGradient816"
       osb:paint="solid">
      <stop
         style="stop-color:#000000;stop-opacity:1;"
         offset="0"
         id="stop814" />
    </linearGradient>
  </defs>
  <g
     style="fill-opacity:1;fill-rule:nonzero;fill:#f2f2f2"
     id="g10"
     stroke="none"
     fill="#000000"
     transform="translate(0.000000,400.000000) scale(0.100000,-0.100000)">
    <path
       style="fill-opacity:1;fill-rule:nonzero;fill:#f2f2f2"
       d="m 1605,2599 c -144,-34 -210,-202 -130,-330 17,-26 78,-65 130,-84 47,-16 53,-16 109,0 166,48 223,240 106,355 -55,54 -138,76 -215,59 z m -167,775 c -7,-6 -12,-333 -5,-334 1,-1 31,-3 67,-6 142,-11 277,-54 404,-128 84,-50 217,-177 276,-265 77,-115 130,-269 145,-423 l 7,-68 h 169 169 v 58 c 0,135 -47,322 -120,477 -136,292 -401,527 -708,629 -128,43 -384,81 -404,60 z m -603,1 c -48,-17 -80,-52 -94,-103 -14,-49 -15,-3146 -1,-3171 19,-36 68,-46 225,-46 125,0 155,3 183,18 17,10 33,19 34,20 2,1 5,328 8,727 l 5,725 179,3 c 305,4 438,-34 578,-167 133,-125 177,-210 434,-845 107,-265 182,-438 195,-448 37,-31 97,-40 243,-36 175,4 200,13 204,76 3,46 -38,155 -228,602 -51,118 -108,253 -127,300 -127,309 -270,509 -431,603 -63,37 -73,52 -40,62 53,16 165,70 236,113 72,43 212,165 212,183 0,5 -126,9 -281,9 h -280 l -71,-30 c -135,-58 -175,-63 -515,-68 l -313,-4 v 565 566 l 43,3 42,3 v 175 175 l -200,2 c -152,2 -210,-1 -240,-12 z m 607,355 c 2,-113 6,-164 14,-163 23,4 212,-18 283,-34 107,-23 391,-135 391,-154 0,-5 4,-9 10,-9 18,0 165,-105 235,-167 140,-126 214,-226 336,-448 32,-58 72,-175 89,-260 7,-33 16,-69 20,-80 10,-23 18,-72 26,-172 l 7,-73 h 165 165 l -7,73 c -13,147 -41,313 -66,392 -5,17 -17,55 -26,85 -18,63 -159,356 -175,366 -6,3 -30,36 -53,73 -75,115 -235,281 -356,368 -36,26 -71,53 -78,60 -17,16 -189,113 -202,113 -5,0 -10,5 -10,10 0,6 -7,10 -15,10 -8,0 -15,4 -15,9 0,5 -10,11 -22,14 -13,3 -88,28 -168,55 -170,58 -328,90 -458,94 l -92,3 z"
       id="path8" />
  </g>
</svg>

</a>--

<!--a id="linkedin-link"
    class="icon" title="LinkedIn" aria-label="LinkedIn"
    href="https://linkedin.com/in/krzysztof-joachimiak">
  <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 490.732 490.732" style="enable-background:new 0 0 490.732 490.732;"
	 xml:space="preserve">
<g>
	<g>
		<path d="M472.366,0.003H18.36C8.219,0.003,0,8.222,0,18.363v454.005c0,10.143,8.219,18.361,18.36,18.361h454.012
			c10.142,0,18.36-8.219,18.36-18.361V18.363C490.727,8.222,482.507,0.003,472.366,0.003z M130.375,403.808
			c0,6.762-5.478,12.238-12.24,12.238H69.132c-6.756,0-12.24-5.477-12.24-12.238V189.625c0-6.763,5.484-12.24,12.24-12.24h49.003
			c6.762,0,12.24,5.477,12.24,12.24V403.808z M130.375,127.482c0,6.763-5.478,12.24-12.24,12.24H69.132
			c-6.756,0-12.24-5.478-12.24-12.24V83.969c0-6.763,5.484-12.24,12.24-12.24h49.003c6.762,0,12.24,5.477,12.24,12.24V127.482z
			 M433.835,403.808c0,6.762-5.483,12.238-12.24,12.238h-49.003c-6.763,0-12.24-5.477-12.24-12.238v-90.436
			c0-29.988-1.566-49.383-4.712-58.189c-3.14-8.807-8.237-15.649-15.3-20.526c-7.062-4.884-15.558-7.32-25.496-7.32
			c-12.729,0-24.149,3.488-34.26,10.459c-10.11,6.977-17.038,16.211-20.79,27.717c-3.745,11.506-5.618,32.779-5.618,63.807v74.488
			c0,6.762-5.483,12.238-12.24,12.238h-49.003c-6.756,0-12.24-5.477-12.24-12.238V189.625c0-6.763,5.483-12.24,12.24-12.24h43.771
			c6.763,0,12.24,5.477,12.24,12.24v16.316c0,6.763,3.312,7.852,7.858,2.852c22.864-25.123,50.753-37.687,83.673-37.687
			c16.212,0,31.028,2.919,44.455,8.758c13.422,5.838,23.58,13.292,30.466,22.356c6.885,9.063,11.683,19.351,14.382,30.857
			c2.699,11.505,4.058,27.98,4.058,49.426V403.808L433.835,403.808z"/>
	</g>
</g>
</svg>

</a><!-- Optional additional links to insert for icons links -->

</nav>

  <p>
  &copy; 2020.
  <a href="/LICENSE.md">MIT License.</a>
</p>

  <a href="https://www.r-bloggers.com/" style="font-size:12px">R-bloggers</a> <a href="https://www.rweekly.org/" style="font-size:12px">RWeekly</a>
</div>


    <main class="container">
      <header>
  <h1 class="post-title">Double dispatch in R: S4 vs vctrs</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">21 Sep 2020</span>
  <span class="post-categories">
    
  </span>
</div>


  <div class="post-body">
    <p><a><img src="https://raw.githubusercontent.com/krzjoa/krzjoa.github.io/master/assets/img/2020-09-17-S4-vs-vctrs/S4_vs_vctrs.jpg" align="center" /></a></p>

<h2 id="why-do-we-may-need-double-dispatch">Why do we may need double dispatch?</h2>

<p>In most cases, when writing R scripts or even creating R packages, it is
enough to use standard functions or S3 methods. However, there is one
important field that forces us to consider <strong>double dispatch</strong> question:
<strong>arithmetic operators</strong>.</p>

<p>Suppose we’d like to create a class, which fits the problem we’re
currently working on. Let’s name such class <strong>beer</strong>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">beer</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">type</span><span class="p">){</span><span class="w">
  </span><span class="n">structure</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">),</span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"beer"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">opener</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(){</span><span class="w">
  </span><span class="n">structure</span><span class="p">(</span><span class="nf">list</span><span class="p">(),</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"opener"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">pilsner</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">beer</span><span class="p">(</span><span class="s2">"pilnser"</span><span class="p">)</span><span class="w">
</span><span class="n">my_opener</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">opener</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p>Then, we create an operator which defines some non-standard behaviour.</p>

<ul>
  <li>if we add an opener to the beer, we get an <strong>opened_beer</strong>.</li>
  <li>adding a <strong>numeric</strong> <em>x</em>, we get a case of beers (which even contain
a negative number of bees, i.e. our owe…)</li>
  <li>if second argument is different than a or <strong>opener</strong> or <strong>numeric</strong>,
we get… untouched beer</li>
</ul>

<p>Let’s demonstrate, how does it work:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">`+.beer`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">){</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inherits</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="s2">"opener"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="n">structure</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="w">
          </span><span class="n">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"opened"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">$</span><span class="n">name</span><span class="p">)</span><span class="w">
    </span><span class="p">),</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"opened_beer"</span><span class="p">))</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inherits</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="s2">"It's magic! You've got a case of beers!"</span><span class="p">)</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">structure</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="w">
        </span><span class="n">n_beers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w">
    </span><span class="p">),</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"case_of_beers"</span><span class="p">))</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pilsner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">my_opener</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## $name
## [1] "opened "
## 
## attr(,"class")
## [1] "opened_beer"
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pilsner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">-0.1</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] "It's magic! You've got a case of beers!"

## $n_beers
## [1] 0.9
## 
## attr(,"class")
## [1] "case_of_beers"
</code></pre></div></div>

<p>Don’t you think, that such operations should be <strong>commutative</strong>?</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">my_opener</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pilsner</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## list()
## attr(,"class")
## [1] "opener"
</code></pre></div></div>

<p>What did happen here? This is an example of the way the R interpreter
handles arithmetic operator. It was described with details on <a href="https://yutani.rbind.io/post/double-dispatch-of-s3-method/"><strong>Hiroaki
Yutani’s
blog</strong></a>.
Briefly speaking, in this particular case R engine matched method to the
second argument (not to the first one), because there is no <code class="highlighter-rouge">+.opener</code>
S3 method. What about such trick:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">`+.opener`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w">
</span></code></pre></div></div>

<p>After that, the result is different:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">my_opener</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pilsner</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Warning: Incompatible methods ("+.opener", "+.beer") for "+"

## Error in my_opener + pilsner: non-numeric argument to binary operator
</code></pre></div></div>

<p>We crashed our function call. When both objects have the <code class="highlighter-rouge">+</code> method
defined and these methods are not the same, R is trying to resolve the
conflict by applying an internal <code class="highlighter-rouge">+</code>. It obviously cannot work. This
case could be easily solved using more ‘ifs’ in the <code class="highlighter-rouge">+.beer</code> beer
function body. But let’s face a different situation.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="m">-0.1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pilsner</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] -0.1
</code></pre></div></div>

<p>What a mess! Simple S3 methods are definitely not the best solution when
we need the double dispatch.</p>

<h2 id="s4-class-a-classic-approach">S4 class: a classic approach</h2>

<p>To civilize such code, we can use classic R approach, S4 methods. We’ll
start from S4 classes declaration.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">.S4_beer</span><span class="w">          </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setClass</span><span class="p">(</span><span class="s2">"S4_beer"</span><span class="p">,</span><span class="w"> </span><span class="n">representation</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"character"</span><span class="p">))</span><span class="w">
</span><span class="n">.S4_opened_beer</span><span class="w">   </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setClass</span><span class="p">(</span><span class="s2">"S4_opened_beer"</span><span class="p">,</span><span class="w"> </span><span class="n">representation</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"character"</span><span class="p">))</span><span class="w">
</span><span class="n">.S4_opener</span><span class="w">        </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setClass</span><span class="p">(</span><span class="s2">"S4_opener"</span><span class="p">,</span><span class="w"> </span><span class="n">representation</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">))</span><span class="w">
</span><span class="n">.S4_case_of_beers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setClass</span><span class="p">(</span><span class="s2">"S4_case_of_beers"</span><span class="p">,</span><span class="w"> </span><span class="n">representation</span><span class="p">(</span><span class="n">n_beers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Then, we can two otptions, how to handle <code class="highlighter-rouge">+</code> operators. I didn’t mention
about it in the previous example, but both S3 and S4 operators are
grouped as so-called <strong>group generic functions</strong> (learn more:
<a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/groupGeneric.html"><strong>S3</strong></a>,
<a href="https://stat.ethz.ch/R-manual/R-devel/library/methods/html/S4groupGeneric.html"><strong>S4</strong></a>).</p>

<p>We can set a S4 method for a single operator and that looks as follows:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">setMethod</span><span class="p">(</span><span class="s2">"+"</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"S4_beer"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"S4_opener"</span><span class="p">),</span><span class="w">
          </span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="p">){</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inherits</span><span class="p">(</span><span class="n">e</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"S4_opener"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="n">.S4_opened_beer</span><span class="p">(</span><span class="n">type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"opened"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">1</span><span class="o">@</span><span class="n">type</span><span class="p">)))</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inherits</span><span class="p">(</span><span class="n">e</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="s2">"It's magic! You've got a case of beers!"</span><span class="p">)</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">.S4_case_of_beers</span><span class="p">(</span><span class="n">n_beers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="p">))</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">})</span><span class="w">

</span><span class="n">setMethod</span><span class="p">(</span><span class="s2">"+"</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"S4_opener"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"S4_beer"</span><span class="p">),</span><span class="w">
          </span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Alternatively, we can define a method for <code class="highlighter-rouge">Arith</code> geneneric and check,
what method is exactly called at the moment. I decided to use the second
approach, because it’s more similar to the way the double dispatch is
implemented in the <strong>vctrs</strong> library.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">.S4_fun</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="p">){</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inherits</span><span class="p">(</span><span class="n">e</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"S4_opener"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="n">.S4_opened_beer</span><span class="p">(</span><span class="n">type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"opened"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">1</span><span class="o">@</span><span class="n">type</span><span class="p">)))</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inherits</span><span class="p">(</span><span class="n">e</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="s2">"It's magic! You've got a case of beers!"</span><span class="p">)</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">.S4_case_of_beers</span><span class="p">(</span><span class="n">n_beers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="p">))</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">setMethod</span><span class="p">(</span><span class="s2">"Arith"</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"S4_beer"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"S4_opener"</span><span class="p">),</span><span class="w">
          </span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="p">)</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.Generic</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
            </span><span class="nf">switch</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w">
                   </span><span class="n">`+`</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">.S4_fun</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="p">),</span><span class="w">
                    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"undefined operation"</span><span class="p">)</span><span class="w">
            </span><span class="p">)</span><span class="w">
</span><span class="p">})</span><span class="w">

</span><span class="n">setMethod</span><span class="p">(</span><span class="s2">"Arith"</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="o">=</span><span class="s2">"S4_opener"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="o">=</span><span class="s2">"S4_beer"</span><span class="p">),</span><span class="w">
          </span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="p">)</span><span class="w">
          </span><span class="p">{</span><span class="w"> 
            </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.Generic</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
            </span><span class="nf">switch</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w">
                   </span><span class="n">`+`</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="m">1</span><span class="p">,</span><span class="w">
                    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"undefined operation"</span><span class="p">)</span><span class="w">
            </span><span class="p">)</span><span class="w">
</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Let’s create our class instances and do a piece of math.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">pilsner</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">.S4_beer</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Pilsner"</span><span class="p">)</span><span class="w">
</span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">opener</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">.S4_opener</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">pilsner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">opener</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## An object of class "S4_opened_beer"
## Slot "type":
## [1] "opened Pilsner"
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">opener</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">pilsner</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## An object of class "S4_opened_beer"
## Slot "type":
## [1] "opened Pilsner"
</code></pre></div></div>

<p>Declared methods are clear, and, the most important: they work
correctly.</p>

<h2 id="vctrs-library-a-tidyverse-approach">vctrs library: a tidyverse approach</h2>

<p><a href="https://github.com/r-lib/vctrs"><strong>vctrs</strong></a> is an interesting library,
thought as a remedy for a couple of R disadvantages. It delivers, among
others, a custom double-dispatch system based on well-known S3
mechanism.</p>

<p>At the first step we declare class ‘constructors’.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">vctrs</span><span class="p">)</span><span class="w">

</span><span class="n">.vec_beer</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">type</span><span class="p">){</span><span class="w">
  </span><span class="n">new_vctr</span><span class="p">(</span><span class="n">.data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">),</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"vec_beer"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">.vec_opened_beer</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">type</span><span class="p">){</span><span class="w">
  </span><span class="n">new_vctr</span><span class="p">(</span><span class="n">.data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">),</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"vec_opened_beer"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">.vec_case_of_beers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">n_beers</span><span class="p">){</span><span class="w">
  </span><span class="n">new_vctr</span><span class="p">(</span><span class="n">.data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">n_beers</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">n_beers</span><span class="p">),</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"vec_case_of_beers"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">.vec_opener</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(){</span><span class="w">
  </span><span class="n">new_vctr</span><span class="p">(</span><span class="n">.data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(),</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"vec_opener"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then, we create class instances.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vec_pilsner</span><span class="w">   </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">.vec_beer</span><span class="p">(</span><span class="s2">"pilnser"</span><span class="p">)</span><span class="w">
</span><span class="n">vec_opener</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">.vec_opener</span><span class="p">()</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="nf">class</span><span class="p">(</span><span class="n">vec_pilsner</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] "vec_beer"   "vctrs_vctr"
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">print</span><span class="p">(</span><span class="nf">class</span><span class="p">(</span><span class="n">vec_opener</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] "vec_opener" "vctrs_vctr"
</code></pre></div></div>

<p>At the end, we write a double-dispatched methods <strong>in vctrs style</strong>. As
you can see,</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">.fun</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">){</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inherits</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="s2">"vec_opener"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="n">.vec_opened_beer</span><span class="p">(</span><span class="n">type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"opened"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">$</span><span class="n">type</span><span class="p">)))</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inherits</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="s2">"It's magic! You've got a case of beers!"</span><span class="p">)</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">.vec_case_of_beers</span><span class="p">(</span><span class="n">n_beers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">vec_arith.vec_beer</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nf">UseMethod</span><span class="p">(</span><span class="s2">"vec_arith.vec_beer"</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">vec_arith.vec_opener</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nf">UseMethod</span><span class="p">(</span><span class="s2">"vec_arith.vec_opener"</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">vec_arith.vec_beer.vec_opener</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p">){</span><span class="w">
  </span><span class="nf">switch</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w">
         </span><span class="n">`+`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.fun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">),</span><span class="w">
         </span><span class="n">stop_incompatible_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">vec_arith.vec_opener.vec_beer</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p">){</span><span class="w">
  </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w">
</span><span class="p">}</span><span class="w"> 

</span><span class="n">vec_pilsner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vec_opener</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## &lt;vec_opened_beer[1]&gt;
##           type 
## opened pilnser
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vec_opener</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vec_pilsner</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## &lt;vec_opened_beer[1]&gt;
##           type 
## opened pilnser
</code></pre></div></div>

<p>It works properly, too.</p>

<h2 id="benchmark">Benchmark</h2>

<p>I’ve created all the classes and methods above not only to demonstate,
how to implement double dispatch in R. My main goal is to benchmark both
approaches and check, which one has smaller overhead. The hardware I
used for the test looks as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## $vendor_id
## [1] "GenuineIntel"
## 
## $model_name
## [1] "Intel(R) Core(TM) i3 CPU       M 350  @ 2.27GHz"
## 
## $no_of_cores
## [1] 4

## 8.19 GB
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sessionInfo</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## R version 3.6.1 (2019-07-05)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 18.04.2 LTS
## 
## Matrix products: default
## BLAS:   /usr/local/lib/R/lib/libRblas.so
## LAPACK: /usr/local/lib/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=pl_PL.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=pl_PL.UTF-8        LC_COLLATE=pl_PL.UTF-8    
##  [5] LC_MONETARY=pl_PL.UTF-8    LC_MESSAGES=en_US.utf8    
##  [7] LC_PAPER=pl_PL.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=pl_PL.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] vctrs_0.2.3
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.3            benchmarkmeData_1.0.3 knitr_1.23           
##  [4] magrittr_1.5          tidyselect_0.2.5      doParallel_1.0.15    
##  [7] lattice_0.20-38       R6_2.4.0              rlang_0.4.2          
## [10] foreach_1.4.7         httr_1.4.1            stringr_1.4.0        
## [13] dplyr_0.8.3           tools_3.6.1           parallel_3.6.1       
## [16] grid_3.6.1            xfun_0.9              htmltools_0.3.6      
## [19] iterators_1.0.12      yaml_2.2.0            digest_0.6.25        
## [22] assertthat_0.2.1      tibble_2.1.3          benchmarkme_1.0.3    
## [25] crayon_1.3.4          Matrix_1.2-17         purrr_0.3.3          
## [28] codetools_0.2-16      glue_1.3.1            evaluate_0.14        
## [31] rmarkdown_1.14        stringi_1.4.3         pillar_1.4.2         
## [34] compiler_3.6.1        pkgconfig_2.0.2
</code></pre></div></div>

<p>It’s my good old notebook, which is not a beast.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">microbenchmark</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="beer--opener">Beer + opener</h3>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bm1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">microbenchmark</span><span class="p">(</span><span class="w">
  </span><span class="n">s</span><span class="m">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">pilsner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">opener</span><span class="p">,</span><span class="w">
  </span><span class="n">s</span><span class="m">3</span><span class="err">_</span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_pilsner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vec_opener</span><span class="p">,</span><span class="w">
  </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Unit: microseconds
##    expr     min       lq      mean   median       uq      max neval
##      s4 153.292 158.2120 178.40541 161.4225 165.6375 5506.681  1000
##  s3_vec  56.686  60.1265  69.52364  68.9240  70.8830  163.278  1000
</code></pre></div></div>

<center>
<img src="https://raw.githubusercontent.com/krzjoa/krzjoa.github.io/master/assets/img/2020-09-17-S4-vs-vctrs/print.results.1-1.png" />
</center>

<h3 id="opener--beer">Opener + beer</h3>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bm2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">microbenchmark</span><span class="p">(</span><span class="w">
  </span><span class="n">s</span><span class="m">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">opener</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">pilsner</span><span class="p">,</span><span class="w">
  </span><span class="n">s</span><span class="m">3</span><span class="err">_</span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_opener</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vec_pilsner</span><span class="p">,</span><span class="w">
  </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Unit: microseconds
##    expr     min       lq      mean   median       uq      max neval
##      s4 159.512 164.6735 191.74781 168.9655 176.3165 6068.477  1000
##  s3_vec  71.110  78.5835  96.22535  86.6720  89.4015 4796.377  1000
</code></pre></div></div>

<center>
<img src="https://raw.githubusercontent.com/krzjoa/krzjoa.github.io/master/assets/img/2020-09-17-S4-vs-vctrs/print.results.2-1.png" />
</center>

<h3 id="bonus-opener--beer-vs-addtion-of-numerics">Bonus: opener + beer vs addtion of numerics</h3>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bm3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">microbenchmark</span><span class="p">(</span><span class="w">
  </span><span class="n">simple_R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w">
  </span><span class="n">s</span><span class="m">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">opener</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">S</span><span class="m">4</span><span class="err">_</span><span class="n">pilsner</span><span class="p">,</span><span class="w">
  </span><span class="n">s</span><span class="m">3</span><span class="err">_</span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_opener</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vec_pilsner</span><span class="p">,</span><span class="w">
  </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Unit: nanoseconds
##      expr    min       lq      mean   median     uq    max neval
##  simple_R    130    344.0    697.49    744.5    857   2862  1000
##        s4 158769 164522.5 189297.35 169270.5 198120 375648  1000
##    s3_vec  74775  78395.5  94786.28  87192.5  94085 258129  1000
</code></pre></div></div>

<center>
<img src="https://raw.githubusercontent.com/krzjoa/krzjoa.github.io/master/assets/img/2020-09-17-S4-vs-vctrs/print.results.3-1.png" />
</center>

<h2 id="conclusions">Conclusions</h2>

<p>It seems that <strong>vctrs-based</strong> performs better than traditional <strong>S4
methods</strong>. Obviously, I checked only one operation and probably some
edge cases may exists. However, I think that it shows us some direction,
what execution time we can expect.</p>

<h2 id="further-sources">Further sources</h2>

<p>If you are interesting, how to implement double-dispatched operators in
S4, I encourage you to get familiar with code of the following R
libraries:</p>

<ul>
  <li><a href="https://github.com/cran/Matrix/blob/master/R/Ops.R">Matrix</a></li>
  <li><a href="https://github.com/cdeterman/gpuR/blob/master/R/methods-gpuVector.R">gpuR</a></li>
</ul>

<p>If you are looking for some examples of <strong>vctrs</strong>, I recommend you to
learn the source code of:</p>

<ul>
  <li><a href="https://github.com/r-lib/rray/blob/master/R/compat-vctrs-arith.R">rray</a></li>
  <li><a href="https://github.com/RMHogervorst/banana/blob/master/R/banana.R">banana</a>
(a funny toy package)</li>
</ul>

    



<div class="post-tags">
  
    
    <a href="/tags.html#en">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">EN</span>
    </a>
  
    
    <a href="/tags.html#r">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">R</span>
    </a>
  
    
    <a href="/tags.html#vctrs">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">vctrs</span>
    </a>
  
    
    <a href="/tags.html#s4">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">S4</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <p>
    You are seeing this because your Disqus shortname is not properly set. To
    configure Disqus, you should edit your <code>_config.yml</code> to include
    either a <code>disqus.shortname</code> variable.
  </p>

  <p>
    If you do not wish to use Disqus, override the
    <code>comments.html</code> partial for this theme.
  </p>


  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/2020/10/03/ts-and-torch-1.html">
            Time Series & torch #1 - Training a network to compute moving average
            <small>03 Oct 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/10/01/s4_vs_vctrs_remake.html">
            S4 vs vctrs library - A Double Dispatch Comparision Remake
            <small>01 Oct 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/09/27/path-chain.html">
            path.chain: Concise Structure for Chainable Paths
            <small>27 Sep 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    <!-- Optional footer content -->
<!--a href="google.com">R-bloggers</a-->

  </body>
</html>
